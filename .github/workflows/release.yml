name: Release

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-cli"

jobs:
  release:
    name: Release
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Check out the code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - name: Tidy modules
        run: go mod tidy
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
      - name: Build and package artifacts
        run: |
          set -euo pipefail
          RAW_TAG=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${RAW_TAG#v}
          RELEASE_KIND=provider
          VERSION=$TAG_VERSION
          if [[ "$TAG_VERSION" == *-cli ]]; then
            RELEASE_KIND=cli
            VERSION=${TAG_VERSION%-cli}
          fi
          RELEASE_DIR=release/dist
          rm -rf "$RELEASE_DIR"
          mkdir -p "$RELEASE_DIR"
          COMBOS=(
            linux/amd64
            linux/arm
            linux/arm64
            windows/amd64
            windows/arm64
            darwin/amd64
            darwin/arm64
          )
          for combo in "${COMBOS[@]}"; do
            os=${combo%/*}
            arch=${combo#*/}
            bin_ext=""
            if [[ "$os" == "windows" ]]; then
              bin_ext=".exe"
            fi
            if [[ "$arch" == "arm" ]]; then
              export GOARM=7
            else
              unset GOARM
            fi
            if [[ "$RELEASE_KIND" == "provider" ]]; then
              bin_name="terraform-provider-grantory_v${VERSION}${bin_ext}"
              CGO_ENABLED=0 GOOS="$os" GOARCH="$arch" go build -o "$RELEASE_DIR/${bin_name}" ./cmd/terraform-provider-grantory
              zip -j "$RELEASE_DIR/terraform-provider-grantory_${VERSION}_${os}_${arch}.zip" "$RELEASE_DIR/${bin_name}"
              rm "$RELEASE_DIR/${bin_name}"
            else
              CGO_ENABLED=0 GOOS="$os" GOARCH="$arch" go build -o "$RELEASE_DIR/grantory${bin_ext}" ./cmd/grantory
              zip -j "$RELEASE_DIR/grantory_${VERSION}_${os}_${arch}.zip" "$RELEASE_DIR/grantory${bin_ext}"
              rm "$RELEASE_DIR/grantory${bin_ext}"
            fi
          done
      - name: Create checksum files
        run: |
          set -euo pipefail
          RAW_TAG=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${RAW_TAG#v}
          RELEASE_KIND=provider
          VERSION=$TAG_VERSION
          if [[ "$TAG_VERSION" == *-cli ]]; then
            RELEASE_KIND=cli
            VERSION=${TAG_VERSION%-cli}
          fi
          cd release/dist
          if [[ "$RELEASE_KIND" == "provider" ]]; then
            sha256sum terraform-provider-grantory_${VERSION}_*.zip > terraform-provider-grantory_${VERSION}_SHA256SUMS
            sha256sum terraform-provider-grantory_${VERSION}_*.zip > checksums_${VERSION}_SHA256SUMS
          else
            sha256sum grantory_${VERSION}_*.zip > grantory_${VERSION}_SHA256SUMS
            sha256sum grantory_${VERSION}_*.zip > checksums_${VERSION}_SHA256SUMS
          fi
      - name: Sign checksum files
        run: |
          set -euo pipefail
          RAW_TAG=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${RAW_TAG#v}
          RELEASE_KIND=provider
          VERSION=$TAG_VERSION
          if [[ "$TAG_VERSION" == *-cli ]]; then
            RELEASE_KIND=cli
            VERSION=${TAG_VERSION%-cli}
          fi
          cd release/dist
          if [[ "$RELEASE_KIND" == "provider" ]]; then
            FILES=(terraform-provider-grantory_${VERSION}_SHA256SUMS checksums_${VERSION}_SHA256SUMS)
          else
            FILES=(grantory_${VERSION}_SHA256SUMS checksums_${VERSION}_SHA256SUMS)
          fi
          for file in "${FILES[@]}"; do
            gpg --batch --yes --detach-sign --output "${file}.sig" "${file}"
          done
      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          files: release/dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
